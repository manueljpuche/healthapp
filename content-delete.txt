
@app.route('/resultados', methods=['POST'])
def resultados():
    
    palabras_clave_str = request.form['palabras_clave']
    fecha_inicio_str = request.form['fecha_inicio']
    fecha_fin_str = request.form['fecha_fin']
    check_palabras = request.form.getlist('check_palabras')
    modalidades_seleccionadas = request.form.getlist('modalidades')
    #medico = request.form['medico']
    
    if 'todas' in modalidades_seleccionadas:
        # No se necesita filtrar por modalidad en la consulta SQL
        sql_modalidades = ''
    else:
        modalidades_str = ','.join([f"'{modalidade}'" for modalidade in modalidades_seleccionadas])
        sql_modalidades = f"AND modalidade IN ({modalidades_str})"
        
    #if medico:
    #    sql_medico = f"AND medico = {medico}"
    #else:
    #    sql_medico = ''

    # Separar las palabras clave en una lista
    palabras_clave = palabras_clave_str.split(",")


    # Convertir las fechas a objetos datetime de Python
    fecha_inicio = datetime.strptime(fecha_inicio_str, '%Y-%m-%d')
    fecha_fin = datetime.strptime(fecha_fin_str, '%Y-%m-%d')

    # Realizar una consulta SQL para recuperar los datos del campo blob y el número de identificación de la tabla que contiene los informes
    cur.execute(f"SELECT num_exame, desc_lfinal, servico, nm_pac, data_exame FROM mediclinic.laudos_finais WHERE data_exame between '{fecha_inicio}' and '{fecha_fin}' {sql_modalidades}")
    
    with open("Buscador\\Lista.txt","w",encoding="utf-8"):
        # Iterar sobre los resultados de la consulta
        for result in cur.fetchall():
            texto_informe = ""
            contenido = bytes(result[1])
            txt = contenido.decode(encoding="ISO-8859-1")
            try:
                texto_informe = rtf_to_text(txt)
            except UnicodeEncodeError:
                with open("Buscador\\error_log","a",encoding="utf-8") as error:
                    error.writelines(f"Se produjo un error al codificar el texto del informe {result[0]}.\n\n")
            
            os = result[0]
            servicio = result[2]
            paciente = result[3]
            fecha = result[4]
            
            if check_palabras:
                list_equals(texto_informe, palabras_clave, servicio, os, paciente, fecha)
            else:
                list_not_equals(texto_informe, palabras_clave, servicio, os, paciente, fecha)                            
    return send_file("Lista.txt", as_attachment=True)


    <!--
      <div class="container_search">
        <h2>Búsqueda en Informes</h2>
        <form action="/resultados" method="post">
          <label>Palabras clave separadas por coma:</label>
          <input type="text" id="palabras_clave" name="palabras_clave"><br><br>
          <label for="fecha_inicio" >Fecha de inicio:</label>
          <input type="text" id="fecha_inicio" name="fecha_inicio"><br><br>
          <label for="fecha_fin">Fecha de fin:</label>
          <input type="text" id="fecha_fin" name="fecha_fin"><br><br>
          <label for="check_palabras">Informes que contengan todas las palabras</label> <input type="checkbox" id="check_palabras" name="check_palabras"><i>  "Si no marca la opcion apareceran los informes que contenga cualquiera de las palabras buscadas"</i> <br><br>
          <label for="modalidades">Modalidades:</label>
          <select id="modalidades" name="modalidades" multiple>
            <option value="todas" selected>Todas las modalidades</option>
            <option value="CR">CR</option>
            <option value="MR">MR</option>
            <option value="CT">CT</option>
            <option value="OT">OT</option>
            <option value="PT">PT</option>
            <option value="MG">MG</option>
            <option value="US">US</option>
            <option value="NM">NM</option>
            <option value="XA">XA</option>
          </select><br><br>
          <label for="medico">Medico:</label>
          <input type="text" id="medico" name="medico" /><br><br>
          <input class="button_cm" type="submit" value="Buscar" />
          
        </form>
        <script>
            $(document).ready(function () {
              $("#fecha_inicio").datepicker({
                dateFormat: "yy-mm-dd",
              });
              $("#fecha_fin").datepicker({
                dateFormat: "yy-mm-dd",
              });
            });
          </script>
      </div>-->